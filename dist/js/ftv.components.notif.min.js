/**
 * The MIT License (MIT)
 *
 * Copyright (c) 2016 France Télévisions
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
 * documentation files (the "Software"), to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and
 * to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions of
 * the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO
 * THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
 * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

angular.module("ftv.components.notif",["ftv.components.notif.templates"]).factory("Notif",["$rootScope",function(t){function i(t){for(var i in t)this[i]=t[i];this.prefix="notif",this.timePrefix="time"}return i.prototype.getKey=function(t){var i=this.prefix;return t&&(i+="-"+t),i+="-"+this.id},i.prototype.setValue=function(t,i){return this.id?localStorage.setItem(this.getKey(i),t):!1},i.prototype.getValue=function(t){if(!this.id)return!1;var i=localStorage.getItem(this.getKey(t));return i?isNaN(i)&&(i=this.getValidatedLimit(),this.setValue(i,t)):i=0,parseInt(i)},i.prototype.setTimeValue=function(t){return this.setValue(t,this.timePrefix)},i.prototype.getTimeValue=function(){return this.getValue(this.timePrefix)},i.prototype.removeValue=function(t){return localStorage.removeItem(this.getKey(t))},i.prototype.removeTimeValue=function(){return this.removeValue(this.timePrefix)},i.prototype.stamp=function(){return this.setTimeValue((new Date).getTime())},i.prototype.inc=function(){var t=this.getValue()+1;t>this.timesShowed&&(t=this.timesShowed+1),this.setValue(t)},i.prototype.update=function(){this.timesShowed&&this.inc(),this.hideFor&&this.stamp()},i.prototype.validate=function(){this.setValue(this.getValidatedLimit()),this.sendClick("sendOnValidate"),this.sendClick("sendOnPublish",!0)},i.prototype.sendClick=function(i,n){this[i]&&t.$emit("ftv.notif.click",this.id,this[i])},i.prototype.sendPublish=function(i){this[i]&&t.$emit("ftv.notif.publish",this.id,this[i])},i.prototype.getValidatedLimit=function(){var t=1;return this.timesShowed&&(t=this.timesShowed),t},i.prototype.hasReachedLimit=function(t){return this.getValue()>=t},i.prototype.isValidated=function(){return this.hasReachedLimit(this.getValidatedLimit())},i.prototype.shouldBeHidden=function(){return this.hideFor?(new Date).getTime()-this.getTimeValue()<36e5*this.hideFor:!1},i}]).service("notifUtil",["$rootScope","Notif",function(t,i){this.notifications=[],this.add=function(t){return t.id&&t.isValidated()?void t.update():void(t.shouldBeHidden()||this.findById(t.id)||this.display(t))},this.create=function(t){return new i(t)},this.display=function(i){this.notifications.push(i),i.update(),t.$emit("ftv.notif.changed",this.notifications)},this.findById=function(t){var i=null;return angular.forEach(this.notifications,function(n){n.id===t&&(i=n)}),i},this.remove=function(t,i){i.sendClick("sendOnRemove"),this._remove(t)},this._remove=function(i){this.notifications.splice(i,1),t.$emit("ftv.notif.changed",this.notifications)}}]).controller("FtvNotifWrapperController",["$scope","notifUtil","$rootScope",function(t,i,n){n.$on("notificationsChanged",function(i,n){t.$$phase||t.$apply(function(){t.notifications=n})}),t.notifications=i.notifications}]).directive("ftvNotifWrapper",function(){return{restrict:"E",templateUrl:"ftv.components.notif.wrapper.html",controller:"FtvNotifWrapperController"}}).directive("ftvNotif",["$timeout","notifUtil","$window",function(t,i,n){return{restrict:"E",replace:"true",scope:{index:"=",notif:"="},link:function(o){o.displayed=!1,o.isInit=!1,o.validate=function(){return o.displayed=!1,o.notif.validate(),o.notif.link?(i._remove(o.notif),n.open(o.notif.link,"ftv-notif")):void t(function(){i._remove(o.notif)},500)},o.close=function(){o.displayed=!1,t(function(){i.remove(o.index,o.notif)},500)},o.init=function(){o.isInit=!0,o.displayed=!0,o.notif.sendPublish("sendOnPublish"),o.notif.duration&&t(function(){o.close()},o.notif.duration)},o.clickCross=function(){o.close()},o.hasLongButton=function(){return o.notif.buttonText?!(o.notif.buttonText.length<13):!1},o.clickButton=function(t){t.stopPropagation(),o.validate(),o.notif.action&&o.notif.action()},o.longButton=o.hasLongButton(),t(function(){o.init()},o.notif.delay||1500)},templateUrl:"ftv.components.notif.single.html"}}]),angular.module("ftv.components.notif.templates",[]).run(["$templateCache",function(t){t.put("ftv.components.notif.single.html",'<!--\n/**\n * The MIT License (MIT)\n *\n * Copyright (c) 2016 France Télévisions\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n * documentation files (the "Software"), to deal in the Software without restriction, including without limitation\n * the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n * to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all copies or substantial portions of\n * the Software.\n *\n * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO\n * THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,\n * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n */\n--><div class="notif" ng-class="{\'notif--error\': notif.error, \'notif--fadeout\': !displayed, \'notif--animated\': isInit, \'notif--removable\': notif.removable}"><ftv-svg-close class="notif__close" ng-if="notif.removable" ng-click="clickCross()"></ftv-svg-close><div class="notif__content" ng-class="{\'notif__content--hasIcon\': notif.icon}"><img class="notif__content__icon" ng-src="{{notif.icon}}" alt="icon" ng-if="notif.icon"> <span class="notif__content__message" ng-class="{\'notif__content__message--longButton\': longButton}">{{notif.message}}</span> <button ng-if="notif.buttonText" class="notif__content__button" ng-click="clickButton($event)">{{notif.buttonText}}</button> <img class="notif__content__picto" ng-if="notif.picto" ng-src="{{notif.picto}}" alt="picto"></div></div>'),t.put("ftv.components.notif.wrapper.html",'<!--\n/**\n * The MIT License (MIT)\n *\n * Copyright (c) 2016 France Télévisions\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n * documentation files (the "Software"), to deal in the Software without restriction, including without limitation\n * the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n * to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all copies or substantial portions of\n * the Software.\n *\n * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO\n * THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,\n * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n */\n--><div class="notifWrapper"><ftv-notif ng-repeat="notif in notifications | limitTo : 2" index="$index" notif="notif"></ftv-notif></div>')}]);